<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yedambnb.mapper.BookingMapper">

   <select id="getBookingsByUserId" resultType="com.yedambnb.vo.BookingVO">
    SELECT
        b.booking_id,
        b.user_no,
        b.accommodation_id,
        b.check_in_date,
        b.check_out_date,
        b.total_price,
        b.booking_status,
        a.name,
        a.price_per_night,
        (SELECT p.photo_path
         FROM   tbl_accommodation_photos p
         WHERE  p.accommodation_id = b.accommodation_id AND ROWNUM = 1) AS photo_path,
         
        r.score,
        r.comment_text
    FROM
        tbl_booking b
    JOIN
        tbl_user u ON b.user_no = u.user_no
    JOIN
        tbl_accommodations a ON b.accommodation_id = a.accommodation_id
    LEFT JOIN
        tbl_review r ON (b.user_no = r.user_no AND b.accommodation_id = r.accommodation_id)
    WHERE
        u.user_id = #{userId}
    ORDER BY
        b.check_in_date DESC
  </select>
 

  <update id="updateBookingStatus" parameterType="map">
    UPDATE TBL_BOOKING
    SET    BOOKING_STATUS = #{status}
    WHERE  BOOKING_ID = #{bookingId}
  </update>


<insert id="insertReservation">
INSERT INTO tbl_booking (user_id, check_in_date, check_out_date, lodging_no, total_price, member_count)
VALUES (#{userId}, #{checkInDate}, #{checkOutDate}, ${lodgingNo}, ${totalPrice}, ${memberCount})
</insert>
</mapper>
